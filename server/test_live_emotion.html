<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FER Model Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .panel {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        #webcam, #captureCanvas {
            width: 100%;
            border-radius: 4px;
        }
        #captureCanvas {
            display: none;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:disabled {
            background-color: #cccccc;
        }
        button.active {
            background-color: #ea4335;
        }
        .emotion-bar {
            height: 20px;
            margin-bottom: 15px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .emotion-fill {
            height: 100%;
            transition: width 0.2s;
        }
        .emotion-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .summary-item {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>FER Model Test</h1>
    
    <div class="container">
        <div class="panel">
            <h2>Camera Feed</h2>
            <video id="webcam" autoplay playsinline></video>
            <canvas id="captureCanvas"></canvas>
            <div>
                <button id="cameraBtn">Start Camera</button>
                <button id="analyzeBtn" disabled>Start Analysis</button>
                <button id="screenshotBtn" disabled>Take Screenshot</button>
            </div>
            <div id="status">Camera inactive</div>
        </div>
        
        <div class="panel">
            <h2>Emotion Analysis</h2>
            <div class="summary">
                <div class="summary-item">
                    <div class="summary-value" id="dominantEmotion">-</div>
                    <div>Dominant Emotion</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="confidence">0%</div>
                    <div>Confidence</div>
                </div>
            </div>
            
            <h3>Emotion Distribution</h3>
            <div id="emotionBars"></div>
        </div>
    </div>
    
    <script>
        // Auth token for your API
        const authToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjdjYzk4YzQ1Y2QwMjcyYjIyMzAyM2JmIiwiZW1haWwiOiJ0ZXN0dXNlckBleGFtcGxlLmNvbSIsInVzZXJuYW1lIjoidGVzdHVzZXIiLCJyb2xlIjoidXNlciIsImV4cCI6MTc0MTgyNjUzOX0.c8UnrNDnCuv6gYfHPg5vzeH0LYDWg1qPB4Y__AVHv44";
        
        // Elements
        const webcamEl = document.getElementById('webcam');
        const captureCanvas = document.getElementById('captureCanvas');
        const cameraBtn = document.getElementById('cameraBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const screenshotBtn = document.getElementById('screenshotBtn');
        const statusEl = document.getElementById('status');
        const dominantEmotionEl = document.getElementById('dominantEmotion');
        const confidenceEl = document.getElementById('confidence');
        const emotionBarsEl = document.getElementById('emotionBars');
        
        // Emotion colors
        const emotionColors = {
            happy: '#4CAF50',
            sad: '#2196F3',
            angry: '#F44336',
            fear: '#FF9800',
            neutral: '#9E9E9E',
            surprise: '#9C27B0',
            disgust: '#795548'
        };
        
        // State
        let stream = null;
        let isAnalyzing = false;
        let analysisInterval = null;
        let sessionId = Date.now().toString();
        
        // Start/stop camera
        cameraBtn.addEventListener('click', async () => {
            if (stream) {
                stopCamera();
            } else {
                await startCamera();
            }
        });
        
        // Start/stop analysis
        analyzeBtn.addEventListener('click', () => {
            if (isAnalyzing) {
                stopAnalysis();
            } else {
                startAnalysis();
            }
        });
        
        // Take screenshot
        screenshotBtn.addEventListener('click', () => {
            if (!webcamEl.srcObject) return;
            
            const context = captureCanvas.getContext('2d');
            captureCanvas.width = webcamEl.videoWidth;
            captureCanvas.height = webcamEl.videoHeight;
            context.drawImage(webcamEl, 0, 0, captureCanvas.width, captureCanvas.height);
            
            const imageData = captureCanvas.toDataURL('image/jpeg');
            analyzeFrame(imageData, true);
            
            statusEl.textContent = 'Screenshot captured and analyzed';
        });
        
        // Start webcam
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                webcamEl.srcObject = stream;
                
                cameraBtn.textContent = 'Stop Camera';
                analyzeBtn.disabled = false;
                screenshotBtn.disabled = false;
                statusEl.textContent = 'Camera active';
            } catch (err) {
                console.error('Error accessing camera:', err);
                statusEl.textContent = 'Error: ' + err.message;
            }
        }
        
        // Stop webcam
        function stopCamera() {
            if (isAnalyzing) {
                stopAnalysis();
            }
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                webcamEl.srcObject = null;
                
                cameraBtn.textContent = 'Start Camera';
                analyzeBtn.disabled = true;
                screenshotBtn.disabled = true;
                statusEl.textContent = 'Camera stopped';
            }
        }
        
        // Start continuous analysis
        function startAnalysis() {
            if (!stream) return;
            
            isAnalyzing = true;
            analyzeBtn.textContent = 'Stop Analysis';
            analyzeBtn.classList.add('active');
            
            // Clear previous interval just in case
            if (analysisInterval) {
                clearInterval(analysisInterval);
            }
            
            // Start new interval for continuous analysis (4 frames per second)
            analysisInterval = setInterval(captureAndAnalyze, 250);
            
            statusEl.textContent = 'Analyzing...';
        }
        
        // Stop continuous analysis
        function stopAnalysis() {
            isAnalyzing = false;
            analyzeBtn.textContent = 'Start Analysis';
            analyzeBtn.classList.remove('active');
            
            if (analysisInterval) {
                clearInterval(analysisInterval);
                analysisInterval = null;
            }
            
            statusEl.textContent = 'Analysis stopped. Camera active.';
        }
        
        // Capture current frame and analyze
        function captureAndAnalyze() {
            if (!isAnalyzing || !webcamEl.srcObject) return;
            
            const context = captureCanvas.getContext('2d');
            captureCanvas.width = webcamEl.videoWidth;
            captureCanvas.height = webcamEl.videoHeight;
            context.drawImage(webcamEl, 0, 0, captureCanvas.width, captureCanvas.height);
            
            const imageData = captureCanvas.toDataURL('image/jpeg');
            analyzeFrame(imageData);
        }
        
        // Send frame to API for analysis
        async function analyzeFrame(imageData, isScreenshot = false) {
            try {
                const response = await fetch('http://localhost:8000/api/emotions/test-live/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        frame: imageData,
                        session_id: sessionId,
                        real_time: !isScreenshot
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${await response.text()}`);
                }

                
                const result = await response.json();

                console.log('Analysis result:', result);
                displayResults(result);
                
            } catch (err) {
                console.error('Analysis error:', err);
                statusEl.textContent = 'Error: ' + err.message;
            }
        }
        
        // Display analysis results
        function displayResults(result) {
            // Update dominant emotion
            dominantEmotionEl.textContent = result.dominant_emotion || '-';
            
            // Update confidence
            const confidence = result.confidence ? Math.round(result.confidence * 100) : 0;
            confidenceEl.textContent = `${confidence}%`;
            
            // Update emotion bars
            emotionBarsEl.innerHTML = '';
            const emotions = result.emotions || {};
            
            // Sort emotions by value (highest first)
            const sortedEmotions = Object.entries(emotions)
                .sort((a, b) => b[1] - a[1]);
            
            for (const [emotion, value] of sortedEmotions) {
                const percentage = Math.round(value * 100);
                
                const container = document.createElement('div');
                container.className = 'emotion-container';
                
                const label = document.createElement('div');
                label.className = 'emotion-label';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = `${percentage}%`;
                
                label.appendChild(nameSpan);
                label.appendChild(valueSpan);
                
                const bar = document.createElement('div');
                bar.className = 'emotion-bar';
                
                const fill = document.createElement('div');
                fill.className = 'emotion-fill';
                fill.style.width = `${percentage}%`;
                fill.style.backgroundColor = emotionColors[emotion] || '#9E9E9E';
                
                bar.appendChild(fill);
                
                container.appendChild(label);
                container.appendChild(bar);
                emotionBarsEl.appendChild(container);
            }
        }
    </script>
</body>
</html>